<html lang="en">
  <head>
  <script src="antimony/libantimony.js" type="text/javascript"></script>
  <script src="antimony/libantimony.wasm" type="application/wasm"> </script>  
  </head>
	
<body>



<script type="text/javascript">
var antCode;
var sbmlCode;
var sbmlResult = 'None';
var antResult = 'None';

var loadAntimonyString; // libantimony function
var loadString;			// 		"
var loadSBMLString;		//		"
var getSBMLString;		//		"
var getAntimonyString;	//		"
var getCompSBMLString;	//		"
var clearPreviousLoads; //		"
var getLastError;		//		"
var getWarnings;		//		"
var getSBMLInfoMessages;//		"
var getSBMLWarnings;	//		"
var freeAll;			//		"

// Load library functions (asynchronous call):
try {
 libantimony().then((libantimony) => {
 //	Format: libantimony.cwrap( function name, return type, input param array of types).
 loadString = libantimony.cwrap('loadString', 'number', ['string']);
 loadAntimonyString = libantimony.cwrap('loadAntimonyString', 'number', ['string']);
 loadSBMLString = libantimony.cwrap('loadSBMLString', 'number', ['string']);
 getSBMLString = libantimony.cwrap('getSBMLString', 'string', ['null']);
 getAntimonyString = libantimony.cwrap('getAntimonyString', 'string', ['null']);
 getCompSBMLString = libantimony.cwrap('getCompSBMLString', 'string', ['string']); 
 clearPreviousLoads = libantimony.cwrap('clearPreviousLoads', 'null', ['null']);
 getLastError = libantimony.cwrap('getLastError', 'string', ['null']);
 getWarnings = libantimony.cwrap('getWarnings', 'string', ['null']);
 getSBMLInfoMessages = libantimony.cwrap('getSBMLInfoMessages', 'string', ['string']);
 getSBMLWarnings = libantimony.cwrap('getSBMLWarnings', 'string', ['string']);
 freeAll = libantimony.cwrap('freeAll', 'null', ['null']);
 });
}
catch(err) {
  console.log('Load libantimony error: ', err);
}

</script>

<script type="text/javascript">

function processAntimony() {
 antCode = document.getElementById("antimonycode").value;
 clearPreviousLoads();
 //console.log("*** Antimony code: ",antCode);
 var load_int= loadAntimonyString(antCode);
 console.log("processAntimony: int returned: ", load_int);
 if (load_int > 0) {
   sbmlResult = getSBMLString(); 
   document.getElementById("sbmlcode").value = sbmlResult;
   document.getElementById("procSBMLBtn").disabled = false;
   document.getElementById("copySBMLBtn").disabled = false;
   document.getElementById("saveSBMLBtn").disabled = false;
 }
 else { 
   var errStr = getLastError();
   window.alert(errStr); }

}

function processSBML() {
 sbmlCode = document.getElementById("sbmlcode").value;
 clearPreviousLoads();
 var load_int= loadSBMLString(sbmlCode);
 console.log("processSBML: int returned: ", load_int);
 if (load_int > 0) {
   antResult = getAntimonyString(); 
   document.getElementById("antimonycode").value = antResult;
   document.getElementById("procAntimonyBtn").disabled = false;
   document.getElementById("copyAntimonyBtn").disabled = false;
   document.getElementById("saveAntimonyBtn").disabled = false;
 }
 else { 
   var errStr = getLastError();
   window.alert(errStr); 
   }

 
}
 function processFile(fileStr) {
 //console.log('Loaded Model str: ', fileStr);
 try {
   if(loadAntimonyString(fileStr) > 0) {
	 document.getElementById("antimonycode").value = fileStr; 
	 document.getElementById("procSBMLBtn").disabled = true;
	 document.getElementById("sbmlcode").value = "[SBML code here.]";
	 processAntimony();}
	 else if (loadSBMLString(fileStr) > 0){  
	   document.getElementById("sbmlcode").value = fileStr; 
	   document.getElementById("procAntimonyBtn").disabled = true;
	   document.getElementById("antimonycode").value = "[Antimony code here.]";
	   processSBML();
	   }
	  else {
	    var errStr = getLastError();
		window.alert(errStr);
		clearPreviousLoads();
		}
	}
	catch(err) {
	  console.log('processing file error: :', err);
	  window.alert(err);
	}
 }

function copyToClipboard(copyType) {
  var copyText;
  if (copyType == 'antimony') {
    copyText = document.getElementById("antimonycode");
  }
  else {
    copyText = document.getElementById("sbmlcode");
  }
  
  // Select the text field
  copyText.select();
  copyText.setSelectionRange(0, 99999); // For mobile devices
  // Copy the text inside the text field
  navigator.clipboard.writeText(copyText.value);

}

function saveCode(codeType) {
  var fileExt;
  if (codeType == 'antimony') { fileExt = ".txt"; }
  else { fileExt = '.xml';}
  if (promptFilename = prompt("Save file as (" + fileExt + ") ", "")) {
		var textBlob;
		if (codeType == 'antimony') {
		  textBlob = new Blob([document.getElementById("antimonycode").value], {type:'text/plain'});
		  }
		else textBlob = new Blob([document.getElementById("sbmlcode").value], {type:'text/plain'});
		var downloadLink = document.createElement("a");
		downloadLink.download = promptFilename + fileExt;
		downloadLink.innerHTML = "Download File";
		downloadLink.href = window.URL.createObjectURL(textBlob);
		downloadLink.click();
    delete downloadLink;
    delete textBlob;
	}

}

</script>
<!-- *** Page layout *** -->
<p>
<h1>Make SBML models </h1>
</p>
<p>
Convert Antimony to SBML or vice-versa:
<ul>

<li>Load an Antimony or SBML file to be converted: </li>
 <input type="file" name="inputfile" id="inputfile">
    <br> 
    <script type="text/javascript">
        document.getElementById('inputfile')
            .addEventListener('change', function() {
            var fr=new FileReader();
            fr.onload=function(){
				var modelString = fr.result;
				processFile(modelString);
            }         
            fr.readAsText(this.files[0]);
        })
    </script>
</p>
<p></p>
<p>
<li><label>Or type or paste in your Antimony:</label></li></br>
<textarea id="antimonycode" rows="20" cols="80" maxlength="1000000">
[Antimony code here.]
</textarea>
</p>
<p>
<input type = "button" id="procAntimonyBtn" onclick = "processAntimony()" value = "Convert Antimony to SBML">
</p>
<p>
<table><tr>
<td> <input type = "button" id="copyAntimonyBtn" style="background-color:#527aad;color:white;" disabled onclick = "copyToClipboard('antimony')" value = "Copy Antimony to clipboard"></td>
<td><input type = "button" id="saveAntimonyBtn" style="background-color:#527aad;color:white;" disabled onclick = "saveCode('antimony')" value = "Save Antimony to file"></td>
</tr>
</table>
</p><p>
</p>
<p>
<li><label>Or SBML:</label></li></br>
<textarea id="sbmlcode" rows="20" cols="80" maxlength="2000000">
[SBML code here.]
</textarea>
</p>
<p>
<input type = "button" id="procSBMLBtn" onclick = "processSBML()" value = "Convert SBML to Antimony">
</p>
<p>
<table><tr>
<td> <input type = "button" id="copySBMLBtn" style="background-color:#527aad;color:white;" disabled onclick = "copyToClipboard('sbml')" value = "Copy SBML to clipboard"></td>
<td><input type = "button" id="saveSBMLBtn" style="background-color:#527aad;color:white;" disabled onclick = "saveCode('sbml')" value = "Save SBML to file"></td>
</tr>
</table>
</p>
</ul>
</body>

</html>
